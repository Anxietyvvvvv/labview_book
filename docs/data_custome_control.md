# 用户自定义控件

## 枚举

在介绍用户自定义控件之前，我们先来介绍一个新的数据类型：枚举类型。枚举是只列出一个有限数据集的所有成员，比如，“星期”的枚举类型，星期日、星期一、星期二、 星期三、星期四、星期五、星期六是这个枚举里面的成员。编程语言中，通常使用一段连续的非负整数来代表枚举类型中的每个程序员，比如用 0 代表星期日、1 代表星期一等等。有些编程语言也允许使用字符串数据来代表枚举类型，但是在 LabVIEW 中，枚举类型的定义是狭义的，它的数值必须是一段从 0 开始的连续非负整数。

### 枚举型控件与下拉列表控件的比较

讨论到枚举型（Enum）控件，就一定要提及下拉列表(Ring)控件，因为这两个控件在外观上极为相似。它们都在“下拉列表和枚举”控件选板上。当然它们都各自有一些不同风格的控件，下图两个控件采用的都是系统风格：

![](images/image78.png "下拉列表和枚举型控件的外观")

虽然它们看上去一模一样，但这两个控件的数据类型却是不同的：枚举控件的数据类型是枚举型；而下拉列表属于数值型。这也就造成了两种控件的行为有很大却别。下面以表格的形式列举一下这两种控件的主要区别：

| 控件类型 | ![](images/image79.png) | ![](images/image80.png) |
| ----- | ----------- | ----------- |
| 数据类型 | 数值型 | 枚举型 |
| 表示法 | 支持任何浮点实数类型，包括：EXT, DBL, SGL, I64, I32, I16, I8, U64, U32, U16, U8 <br /> ![](images/image81.png) | 正如之前提到的，枚举数据必须是一段从 0 开始的连续非负整数，所以它只支持三种无符号整数类型：U32, U16, U8 <br /> ![](images/image82.png) |
| 设置数值 | 可以给每个条目设定任意的数值，但每个条目的值必须唯一，不能有数值相同的条目。 | 只能按照顺序给每个条目设定一个整数值。从 0 开始，之后每个条目加 1。 |
| 作为条件结构的条件 | 作为一种数值型控件，它的行为与其它数值类型并无区别。在条件结构的选择标签中，按照每个条目的值来判断条件是否满足。条件结构无法知道下拉列表中有多少条目，必须手工输入所有可能出现的条件值。 <br /> ![](images/image83.png) | 按照每个条目的标签来判断条件是否满足。条件结构知道枚举类型中每个条目，条件结构鼠标右键菜单中可以选择自动为每个枚举中的条目添加分支。 <br /> ![](images/image84.png) |
| 动态修改条目标签 | 可以通过控件的属性设置，在程序运行时，动态修改下拉列表每一项的标签。 | 只能在编辑状态下修改枚举型每一项的标签。VI 运行时不能修改。 |
| 类型严格性 | 所有下拉列表都是同一种数据类型：数值型，条目有所不同的两个下拉列表可以直接相互赋值。 <br /> ![](images/image85.png)  | 拥有不同条目的枚举属于不同数据类型（枚举型是一类数据类型，不是一个特定的数据类型），它们之间不能直接赋值。如需赋值，需要首先强制转换成一般数值类型，再转换成另一枚举类型。  <br /> ![](images/image86.png)   <br /> ![](images/image87.png)  |


通过上面的对比，我们可以得出以下一些结论：

在程序中，表示有限的几种物件、几个状态等含义时，应尽量使用枚举控件而不是下拉列表。因为枚举控件的数据类型更加严格，可以防止程序中的某些错误。并且，这样的数据在程序中通常会与选择结构相连，以对不同的状态、类别等进行分别处理。枚举控件能够让条件结构按照条目标签来选择分支，可以增加程序的可读性和可维护性。

当程序需要表示的依然是一个数值，只不过需要把用户的输入限定在某几个特定值的时候，应当使用下拉列表控件。

比如，我们编写一段程序，用于模拟一台示波器，它有三种触发模式：边沿触发，脉宽触发和斜率触发。此时程序应该选用枚举类型的控件表示触发模式。这台示波器可显示的波形幅值范围也有三档，分别是：0.1V、0.25V 和 1V。它们是离散的数值，应该用下拉列表来表示这三个幅值范围。

### 单选按钮控件

除了下拉式的枚举型控件外，LabVIEW 中单选按钮控件（Radio Buttons）的数据类型也是枚举型的。单选按钮只是在外观上与下拉式的枚举控件不同，它由一组布尔型控件组成（可以根据需要选择改变选项的外观，以及设置一定数量的选项）。在一组控件中，每次只能有一个值为真。整个单选按钮的值，就是为真值的那个布尔控件所在的位置。下图是几个不同外观的单选按钮控件：

![](images/image88.png "单选按钮控件") ![](images/image89.png "单选按钮控件")![](images/image90.png "单选按钮控件")![](images/image91.png "单选按钮控件")

单选按钮控件的优点是，所有可选的条目都直接显示在界面上，而枚举控件必须在操作中按下控件后才能查看条目内容；缺点是单选控件占用界面的尺寸比下拉式的枚举型控件大。

### 创建和使用一个枚举控件

假设有一个数学竞赛，有三支队伍参加比赛，分别是 Team A, Team B, Team C。我们需要编写一个程序对三支队伍的数据分别做处理，我们可以使用一个枚举类型来表示参赛的队伍。下面我们编写两个 VI，分别是主 VI 和 子 VI 来演示枚举类型控件的创建和使用。首先，创建一个枚举控件，在主 VI “enum_main.vi”的前面板上放置一个枚举控件。新放置的枚举控件是空，需要在它的鼠标右键菜单中添加成员条目。下图是枚举控件属性对话框中的“编辑条目”页面，我们在这里添加上三支队伍的名字：

![](images_2/z213.png "编辑条目")

假如，处理数据的工作是在子 VI “enum_sub.vi”中完成的，那么我们就需要把这个枚举数据传递到子 VI 中去，因此，子 VI 必须要有一个同样枚举类型的输入控件负责接收数据。因为两个 VI 中使用的是同样的控件，我们没必要再从头开始创建一个新的枚举控件，只要 Ctrl C，Ctrl V 把控件从主 VI 复制到子 VI 就可以了。除了用复制粘贴快捷键，直接使用鼠标把控件拖拽到另一个 VI 上，也可以实现复制：

![](images_2/z214.gif "复制控件")

子 VI 的程序框图如下，这里主要演示枚举类型控件，所以并没有在条件结构内添加真正的处理数据代码：

![](images_2/z215.png "子 VI 的程序框图")

主 VI 的程序框图也是极其简单，仅仅是把枚举类型数据传递给子 VI：

![](images_2/z216.png "主 VI 的程序框图")

这样一个简单的演示程序就完成了。可是这时候出现了一个新的需求：参赛队伍“Team C”改名为“Team D”了。我们可以在编辑条目的对话框上把主 VI 的枚举控件修改一下：

![](images_2/z217.gif "改变枚举类型")

读者们可能已经发现了，在修改了主 VI 的枚举控件之后，VI 出错无法运行了。这是因为子 VI 中的枚举控件还没有被修改，主 VI 和子 VI 中的两个枚举控件现在具有不同的数据类型，它们之间无法传递数据。我们可以打开子 VI，对它的枚举控件做相同的修改。示例中只有两个 VI，所以这样的修改并不麻烦，但是，在一个大型项目中，同样的枚举控件也许被用在了数十个子 VI 中，逐一修改它们就太过繁琐了，有没有什么方法可以把不同 VI 中用到的相同数据类型的控件都关联起来呢？这样只要在一个地方修改这个控件，所有 VI 上相关的控件就都自动被更新好了。

确实有这样的方法，就是利用 LabVIEW 中的用户自定义控件

## 用户自定义控件

虽然 LabVIEW 已经提供了种类繁多的控件，但肯定还是无法满足某些编程者的需求。开发者有时会希望能够自制一些外观特殊的控件，这需要制作用户自定义控件。

如果需要创建外观非常精美的控件，它的难度主要在于创意和美术设计方面，而非编程方面。制作这样的控件，首先要准备好相应的素材，即一些漂亮的图片。然后用这些漂亮图片代替 LabVIEW 控件原有的图片即可。

### 创建一个自定义控件

制作自定义控件，常见方法是在一个已有的 LabVIEW 控件上进行改造。一般来说，几乎不可能完全从空白开始，凭空创建出一个与 LabVIEW 已有控件毫不相关的控件来。比如说，我们要创建用户自定义后退按钮，可以把 LabVIEW 已有的按钮作为模板，在其基础上进行改造。

创建自定义控件，首先要创建一个.ctl 文件。创建.ctl 文件有两种方法。可以从菜单项 "文件 -> 新建 -> 自定义控件" 开始。这样创建出来的是一个空白.ctl 文件，在此.ctl 文件界面上添加一个 LabVIEW 自带的按钮控件，再进行修改就可以了。此外，还可以右键点击前面板上的某一控件，选择 "高级 -> 自定义" 即可新建一个带有这一控件的.ctl 文件（图 10.32）。

![](images/image618.png)

图 .32 以某一控件为模板，创建自定义控件

.ctl 文件的界面与 VI 前面板看起来非常相似。在它的界面上只允许放置一个控件，缺少控件或超过一个控件，工具栏上就会出现错误提示标志（图 10.33）。在它的面板上可以放置多个装饰图形或标签文字。.ctl 文件没有程序框图，因此它只能定义控件的外观或数据类型，不能定义控件的行为。

![](images/image619.png)

图 .33 当面板上出现两个控件，工具栏出现错误提示

### 自定义控件的组成部分

.ctl 文件有三种类型："输入控件"、"自定义类型" 和 "严格自定义类型"（图 10.34）。在工具栏的 "控件类型" 下拉菜单中可以选择其类型。其中，"输入控件" 是指一般的自定义控件，它用于自定义控件的外观。而 "自定义类型" 和 "严格自定义类型" 除了可以定义一个控件的外观，它们最主要的用途还在于定义一个控件的数据类型。这一章主要讨论定义控件的外观，下一章再介绍自定义数据类型。所以这里仅介绍 "输入控件" 类型的自定义控件。

![](images/image620.png)

图 .34 选择控件类型

控件类型下拉框左面是一个显示为扳手或镊子图形的按钮，按动它，界面可以在 "编辑模式" 和 "自定义模式" 间切换。在编辑模式下，可以修改控件的尺寸、颜色等属性（这与在 VI 的前面板上直接修改控件属性相同）；在自定义模式下，则可以把控件的各个部分拆解开来，进行更细致的修改，从而彻底改变控件的外观。

在自定义模式下，控件每个可拆分的部分都被一个白色框所包裹，以利于区分。不同的控件，其组成成份完全不同。比如，最简单的按钮，由标签、按钮主体部分、布尔文本三部分组成；而滑动杆控件则复杂得多，它由标签、左移动按钮、右移动按钮，左侧背景颜色、右侧背景颜色、滑动杆、标尺、背景边框、数字显示、单位标签等多个部分组成（图 10.35）。

![](images/image621.png) ![](images/image622.png)

图 .35 自定义模式下可拆解控件的组成部分

### 修改控件组成部分

假如，要把控件做成类似浏览器的回退按钮模样。其外观图片为：![](images/image623.png)

在修改自定义控件之前，先准备好需要使用的图片文件。

最简单的方法是用图片来代替控件原有的布尔文本。在自定义模式下，右键点击按钮的布尔文字部分，选择 "从文件导入..."（图 10.36），再选择已准备好的图片文件。这样，控件中原有的部分，就被导入的图片替代了。

![](images/image624.png)

图 .36 导入图片，替代控件已有部分

使用这种方法做出来的按钮如图 10.37 所示，它看上去类似 Windows 2000 之前的风格，有些落伍了。

更好的方式不是把圆形图片贴在方形按钮上，而是用导入图片替代模板控件的按钮主题部分，直接做成一个圆形的按钮。

![](images/image625.png)

图 .37 用导入图片替代布尔文字部分后的自定义控件效果

具体操作如下：

按钮是圆形的，而所有图片文件都是矩形的。为此，要求矩形图片上只有一个圆形图案，而圆形之外的部分是透明的。常见的图像文件中，png 文件对透明支持得最好。所以，需要采用 png 文件制作按钮素材。

按钮的主题部分需要四张图片分别表示四种不同的状态：真、假、真至假、假至真。但如果是一个触发型按钮，那只有两种状态：正常状态与鼠标按下状态。所以，在这个例子中只需要两幅图片：未按鼠标时，采用一种图片；鼠标按下时，采用另一幅颜色较深的图片。

在自定义模式下，鼠标右键点击控件的主体部分，可以看到 "从剪贴板导入图片"、"从文件导入" 等选项。利用这些选项可以把按钮控件当前状态的外观图片替换掉。通过鼠标右键菜单的 "图片项" 可以切换到按钮的其它状态，再把其它几个状态的图片都一一替换掉（图 10.38、图 10.39）。

![](images/image626.png)

图 .38 选择按钮主体部分不同的图片项

![](images/image627.png)

图 .39 导入新图片后按钮的四个图片项

这个自定义控件的机械动作需要被设置为 "释放时触发"。在应用程序中使用它的效果如图 10.40 所示。（其中 "布尔 2" 正在被鼠标按下）

![](images/image628.png)

图 .40 圆形按钮的使用效果




## 禁止枚举控件中的某些项

程序要求：创建一个枚举型控件，但在程序运行过程中，需要暂时禁止它的某些选项。

这个过程实现起来相当简单，只要使用一个针对枚举类型的属性 "禁用项 \[\]" 就可以了。该属性的输入值是一个整数数组，数组的中元素的数值表示枚举控件中需要被禁用的选项（从 0 开始）。比如，需要禁用枚举控件中的第二条选项，则需要给 "禁用项 \[\]" 属性提供一个包含一个元素的整数数组，元素的值是 1（图
2.66、图 2.67）。

![](images/image152.png)

图 .66 禁用枚举型控件中的某些选项

![](images/image153.png)

图 .67 运行结果



## 为列表框控件添加自定义的图标

在 LabVIEW
的列表框、树形等控件的每个条目的前端，都可以为其选择并显示出一个图标。选中控件的右键菜单 "显示项 -\> 符号"（
图 2.70），就可以把选取的图标显示出来。

![](images/image156.png)\
图 2.70 显示列表框的符号

控件中每个条目的图标的图案可以直接通过控件每个条目的右键菜单 "项符号" 来选择（图 2.71），也可通过在程序中设置控件的 "项符号" 属性来设置。控件自带的图标都比较简单，并且总共只有 40 个。（最后一个图标其实不是 "图标"，而是分割线，编程时可能会使用到。）

![](images/image157.png)\
图 2.71 选择条目的符号类型

这些控件自带的图案种类非常有限，但 LabVIEW 允许编程者自己定义列表空等控件条目的符号。以列表框控件为例，编程时，使用控件的 "自定义项符号 --> 设置为自定义符号" 方法，可以为控件添加自定义的图标。这个方法节点有两个输入:"索引" 表示图标的序号 (应该给新图标选择一个大于 40 的序号，以免覆盖掉控件自带的图标)；第二个输入参数 "图像" 则是自定义图标的图片（图 2.72）。

![](images/image158.png)\
图 2.72 设置条目自定义图标的程序

在这个例子中，图片
VI.png 是一张彩色的系统用来表示.vi 文件的图标。打开这个图片文件，得到它的图像数据，然后设置给列表框控件。其显示效果为图 2.73 中控件的最后一个条目。

![](images/image159.png)

图 2.73 使用自定义符号的显示效果


## 变体

### 变体数据类型

变体是 LabVIEW 中一种比较特殊的数据类型，其它任何数据类型都可以通过 "编程 -\> 簇、类与变体 -\> 变体 -\> 转换为变体" 函数转换成变体数据类型。需要时，可再通过 "变体至数据转换" 函数将其转换为原数据类型。变体这种数据类型类似于 VB 中的 Variant 和 C 语言中的 void 数据类型。

### 类型转换

其它类型数据在转换为变体数据类型时（图
2.40），变体数据中会记录原数据的类型信息。因此，"变体至数据转换" 只能将变体转换回原数据类型，而不能转换为其它任何类型。在变体的控件上，选中鼠标右键菜单中的 "显示类型" 和 "显示数据"，可以根据要求显示出变体内原数据的类型和数值（图
2.41）。

![](images/image125.png)

图 .40 变体数据转换

![](images/image126.png)

图 .41 在变体控件上显示内部数据的数据类型和值

在程序中，若需要得到变体数据原本的类型，可以使用一个 LabVIEW 自带的 VI（"\[LabVIEW\]\\vi.lib\\Utility\\VariantDataType\\GetTypeInfo.vi"）取出变体中数据的原始类型，然后再根据其原数据类型进行下一步处理（图
2.42）。

![](images/image127.png)

图 .42 从变体中得到元数据类型信息

在这里，我们提到了一个 LabVIEW 自带的 VI，GetTypeInfo.vi。但是这个 VI 并不能在 LabVIEW 的函数选板上找到。在本书后续的章节中，还会继续介绍到多个类似这种情况的 VI。像这种不在函数选板上的 VI，它们一般并不是直接提供给用户去使用的，而是提供给 LabVIEW 中其它 VI 或工具的子 VI。NI 公司没有为这些 VI 撰写文档，所以一般用户无法确切得知这些 VI 的用途，也不知道如何使用它们。不过，这些 VI 中的大部分是公开源代码的，用户可以查看并借鉴它们的实现方法，甚至使用它们搭建自己的应用程序。但是，如果用户把这些 VI 应用在了自己的程序中，则必须要清楚意识到使用它们的风险：第一，NI 公司不提供对这些 VI 的支持和服务。第二，NI 公司不保证这些 VI 在将来的 LabVIEW 版本中不被改动，而一旦这些 VI 被改动，很可能造成直接使用了它们的客户的应用程序出现错误。

### 变体的应用

一般来说，LabVIEW 子 VI 的参数数据类型是固定的，一个子 VI 只能针对一种特定类型的数据进行操作。但是，有些算法也可以适用于多种数据类型。针对多种不同的数据类型，为这一算法编写多个不同的子 VI，这显然不是一个高效的办法。较为行之有效的办法是选用变体数据类型作为子 VI 的参数。这样，任何类型的数据在转变为变体后，都可调用这个子 VI 了。

类似的应用还有：不同类型的数据是不能够放在同一个数组中的。但遇到需要把不同元素放在同一数组中时，可以先把所有数据都转为变体类型，然后构成一个变体类型数组。

### 利用变体实现 Dictionary 容器（字典容器）功能

编程的时候经常会遇到这种情况：需要保存一些数据，这些数据的组织类似一张表格。表格由很多类型相同的条目组成，每个条目由一个唯一的标识符（比如 ID，名称等）和其它一些数据组成。程序能够保存这张表格；对表格中的条目进行修改；并根据标识符快速找到某个条目。

在 C++ 或 C# 中实现这样的功能非常简单，只要使用编程语言提供的 Map、Dictionary 等容器就可以了。这些容器已经具有了维护和查找这张表格的功能，用户只需使用它们的几个简单接口函数。遗憾的是，至今，LabVIEW 尚未提供类似的容器。当然，可以在程序中定义一个簇的数组来保存表单中的数据，然后再编写查询数据的代码。但这种方式编程复杂，查询效率太低。

有一种简便高效的实现类似的功能方法是利用 LabVIEW 自带的用来为变体数据类型设置属性的三个函数来保存和查询数据。这三个函数位于 "编程 -\> 簇、类与变体 -\> 变体" 函数选板，分别是 "获得变体属性"、"设置变体属性" 和 "删除变体属性" 这三个函数。从它们的名字就能知道它们原本的用途了。

![](images/image128.png)\
图 2.43 变体函数选板

变体数据的属性由一个名字和一个数据组成：每个属性的名字都必须是唯一的，数据则可以是任何的数据类型。这样，它恰好适合于前文提到的容器程序需求。可以把表单中的每一个条目看作是变体数据的一个属性：条目的标识就是属性的名称；条目的其它部分是属性的数据。创建和修改表单使用 "获得变体属性" 和 "删除变体属性" 函数；查询表单的内容使用 "设置变体属性" 函数就可以了。

比如图 2.44 所示的程序，其功能是根据学生姓名来查询成绩。在这个程序中，数据是一张表格，表格的第一列为 "姓名"，第二列是 "成绩"。当用户输入一个姓名，程序就查找出相应的成绩，返还给用户。

![](images/image129.png)\
图 2.44 使用变体属性实现 Dictionary 容器的程序框图

![](images/image130.png)\
图 2.45 使用变体属性实现字典容器的程序运行结果

变体的属性在 LabVIEW 中是以哈希表格式存储的。它的查询效率极高，所以特别适合用于需要查询大量数据的程序。

但它毕竟不是一个真正的容器，还有一些局限性，比如它的标识只能使用字符串。在本书第 13.3.5 节，将要更为详细地介绍数据容器。请读者参阅相关章节。